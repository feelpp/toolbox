= Spring
:page-vtkjs: true
:toc: left
:uri-data: https://github.com/feelpp/toolbox/blob/master/examples/modules/csm/examples
:uri-data-edit: https://github.com/feelpp/toolbox/edit/master/examples/modules/csm/examples
:imagesprefix: 
ifdef::env-github,env-browser,env-vscode[:imagesprefix: ../../assets/images/]

== Description

In this example, we simulate the extension of a steel coil spring.

== Running the case

The command line to run this case is
[[command-line]]
[source,sh]
----
mpirun -np 4 feelpp_toolbox_solid --case "github:{repo:toolbox,path:examples/modules/csm/examples/spring}"
----
++++
<button class="btn" data-clipboard-target="#command-line">
Copy command line to clipboard
</button>
<button class="btn" data-clipboard-text="github:{repo:toolbox,path:examples/modules/csm/examples/spring}">
Copy case option to clipboard
</button>
++++

NOTE: The report of the execution of the command above is available xref:spring/solid-informations.adoc[here].

=== Python interface
We start with the {feelpp} environment.

[source,python]
----
from feelpp import *
from feelpp.toolboxes.core import *
from feelpp.toolboxes.solid import *

# create the application
# create a feelppdb subdirectory where the results are stored
app = Environment(['feelpp_toolbox_solid'], opts= toolboxes_options("solid"),config=localRepository(""))
----

Next we download the study configuration and simulate it

[source,python]
----
springcfg=feelpp.download("github:{repo:toolbox,path:examples/modules/csm/examples/spring/}", worldComm=app.worldCommPtr())[0] 
springcfg+='/spring.cfg' 

if os.path.exists(springcfg): 
  app.setConfigFile(springcfg) 
  s = solid(dim=3) 
  ok,meas=simulate(s) 
  if ok:
    # export in paraview format
    s.exportResults() 
----
[%collapsible.result]
.Results
====
----
Reading /home/congo/Document/feelppdb/downloads/spring/spring.cfg...
solid(3,1)
[modelProperties] Loading Model Properties : "/home/congo/Document/feelppdb/downloads/spring/spring.json"
[loadMesh] Loading Gmsh compatible mesh: "/home/congo/Document/feelppdb/downloads/solid/meshes/spring.msh"
[loadMesh] Loading Gmsh compatible mesh: "/home/congo/Document/feelppdb/downloads/solid/meshes/spring.msh" done
 0 solid KSP Residual norm 2.666382e+03
 1 solid KSP Residual norm 5.794911e+00
 2 solid KSP Residual norm 1.438302e+00
 3 solid KSP Residual norm 1.376460e+00
 4 solid KSP Residual norm 3.529754e-02
 5 solid KSP Residual norm 1.722303e-02
 6 solid KSP Residual norm 8.446949e-03
 7 solid KSP Residual norm 7.937000e-03
 8 solid KSP Residual norm 5.918753e-03
 9 solid KSP Residual norm 5.302495e-03
 10 solid KSP Residual norm 5.287803e-03
 11 solid KSP Residual norm 5.241817e-03
 12 solid KSP Residual norm 5.231319e-03
 13 solid KSP Residual norm 5.159547e-03
 14 solid KSP Residual norm 5.122767e-03
 15 solid KSP Residual norm 5.078984e-03
 16 solid KSP Residual norm 5.037953e-03
 17 solid KSP Residual norm 4.997618e-03
 18 solid KSP Residual norm 4.958278e-03
 19 solid KSP Residual norm 4.919848e-03
 20 solid KSP Residual norm 4.882298e-03
 21 solid KSP Residual norm 4.845595e-03
 22 solid KSP Residual norm 4.809708e-03
 23 solid KSP Residual norm 4.774606e-03
 24 solid KSP Residual norm 4.740262e-03
 25 solid KSP Residual norm 4.706648e-03
 26 solid KSP Residual norm 4.673740e-03
 27 solid KSP Residual norm 4.641512e-03
 28 solid KSP Residual norm 4.609942e-03
 29 solid KSP Residual norm 4.579007e-03
 30 solid KSP Residual norm 1.418331e-02
 31 solid KSP Residual norm 1.418331e-02
 32 solid KSP Residual norm 1.414001e-02
 33 solid KSP Residual norm 1.381685e-02
 34 solid KSP Residual norm 1.381187e-02
 35 solid KSP Residual norm 5.663386e-03
 36 solid KSP Residual norm 4.546781e-03
 37 solid KSP Residual norm 3.758845e-03
 38 solid KSP Residual norm 3.620873e-03
 39 solid KSP Residual norm 2.561403e-03
 40 solid KSP Residual norm 2.309503e-03
 41 solid KSP Residual norm 1.911301e-03
 42 solid KSP Residual norm 1.709491e-03
 43 solid KSP Residual norm 1.553256e-03
 44 solid KSP Residual norm 1.434568e-03
 45 solid KSP Residual norm 1.339276e-03
 46 solid KSP Residual norm 1.260792e-03
 47 solid KSP Residual norm 1.194658e-03
 48 solid KSP Residual norm 1.137948e-03
 49 solid KSP Residual norm 1.088615e-03
 50 solid KSP Residual norm 1.045188e-03
 51 solid KSP Residual norm 1.006576e-03
 52 solid KSP Residual norm 9.719491e-04
 53 solid KSP Residual norm 9.406664e-04
 54 solid KSP Residual norm 9.122219e-04
 55 solid KSP Residual norm 8.862111e-04
 56 solid KSP Residual norm 8.623054e-04
 57 solid KSP Residual norm 8.402355e-04
 58 solid KSP Residual norm 8.197778e-04
 59 solid KSP Residual norm 8.007451e-04
 60 solid KSP Residual norm 3.473260e-03
 61 solid KSP Residual norm 3.473260e-03
 62 solid KSP Residual norm 2.645128e-03
 63 solid KSP Residual norm 2.363871e-03
 64 solid KSP Residual norm 2.217282e-03
 65 solid KSP Residual norm 7.074701e-04
 66 solid KSP Residual norm 2.915517e-04
 67 solid KSP Residual norm 2.906449e-04
 68 solid KSP Residual norm 2.777567e-04
 69 solid KSP Residual norm 2.527710e-04
 70 solid KSP Residual norm 2.441053e-04
 71 solid KSP Residual norm 2.399597e-04
 72 solid KSP Residual norm 2.321057e-04
 73 solid KSP Residual norm 2.262180e-04
 74 solid KSP Residual norm 2.204787e-04
 75 solid KSP Residual norm 2.152092e-04
 76 solid KSP Residual norm 2.102909e-04
 77 solid KSP Residual norm 2.056966e-04
 78 solid KSP Residual norm 2.013906e-04
 79 solid KSP Residual norm 1.973442e-04
 80 solid KSP Residual norm 1.935323e-04
 81 solid KSP Residual norm 1.899331e-04
 82 solid KSP Residual norm 1.865275e-04
 83 solid KSP Residual norm 1.832988e-04
 84 solid KSP Residual norm 1.802321e-04
 85 solid KSP Residual norm 1.773144e-04
 86 solid KSP Residual norm 1.745339e-04
 87 solid KSP Residual norm 1.718803e-04
 88 solid KSP Residual norm 1.693441e-04
 89 solid KSP Residual norm 1.669170e-04
 90 solid KSP Residual norm 6.821151e-04
 91 solid KSP Residual norm 6.821150e-04
 92 solid KSP Residual norm 6.681642e-04
 93 solid KSP Residual norm 6.623689e-04
 94 solid KSP Residual norm 5.422561e-04
 95 solid KSP Residual norm 4.490976e-04
 96 solid KSP Residual norm 3.576529e-04
 97 solid KSP Residual norm 1.694319e-04
 98 solid KSP Residual norm 1.144074e-04
 99 solid KSP Residual norm 8.949649e-05
 100 solid KSP Residual norm 6.916455e-05
 101 solid KSP Residual norm 4.569727e-05
 102 solid KSP Residual norm 3.767149e-05
 103 solid KSP Residual norm 3.220917e-05
 104 solid KSP Residual norm 2.862794e-05
 105 solid KSP Residual norm 2.600897e-05
Linear solve converged due to CONVERGED_RTOL iterations 105
----
====
== Data files

The case data files are available in Github link:{uri-data}/spring/[here]:

* link:{uri-data}/spring/spring.json[JSON file] - [link:{uri-data-edit}/spring/spring.json[Edit the file]]
* link:{uri-data}/spring/spring.cfg[CFG file] - [link:{uri-data-edit}/spring/spring.cfg[Edit the file]]


== Geometry

The geometry consists of a 7-turn coil spring.
The spring is 4.5cm long and its radius is 1cm. 
The wire's radius is 1mm.

image:{imagesprefix}spring/spring_mesh.png[50%]

The mesh is available on link:https://girder.math.unistra.fr/api/v1/file/5b03dfcbb0e957402704806d/download[Girder]

== Input parameters

=== Model & Toolbox

The model used is the linear elasticity described in the CSM toolbox, see xref:toolboxes:csm:index.adoc[Computational Solid Dynamics]

=== Materials

The coil spring is entirely made of steel.

[options="header"]
|===
| Name |Description | Value | Unit |
| stem:[E_s] | Young's modulus | stem:[210 \times 10^6]  | stem:[kg.m^{-1}.s^{-2}] |
| stem:[\nu_s] | Poisson's ration | stem:[0.33]  | stem:[dimensionless] |
| stem:[\rho_s] | density | stem:[7850] | stem:[kg/m^3] |
|===

[source,json,indent=0]
----
include::{examplesdir}/spring/spring.json[tags=materials]
----

We also need gravity:

[source,json,indent=0]
----
include::{examplesdir}/spring/spring.json[tags=params]
----

=== Boundary conditions

The top and bottom ends of the spring are were the boundary conditions are applied.
More precisely, we apply boundary conditions on the corresponding surfaces.
We also apply gravity as a volumic force on the whole domain.

==== Top end

We apply a Dirichlet boundary condition here: the spring is considered attached to a fixed body on this surface.
This means the displacement is zero on this surface.

==== Bottom end

On this end, we also impose the displacement, but this time it is non-zero.
This model the application of a certain pulling force along the spring axis which stretches it by 8mm. 

==== Volumic force

Gravity is applied as a volumic force on all the elements of the mesh.

[source,json,indent=0]
----
include::{examplesdir}/spring/spring.json[tags=bc]
----

== Results

[source,python]
----
import pandas as pd
df=pd.DataFrame(meas)
print(df.head())

# prepare for plotting
import plotly.graph_objects as go
----

[%collapsible.result]
.Results
====
----
Paraview files are in /scratch/jupyter/feelppdb/np_1/np_1/solid.exports
  Statistics_disp_max  Statistics_disp_mean_0  Statistics_disp_mean_1  \
0             0.000134               -0.000076               -0.000056   

   Statistics_disp_mean_2  Statistics_disp_min  Statistics_von-mises_max  \
0               -0.004154            -0.008009              3.154187e+06   

   Statistics_von-mises_mean  Statistics_von-mises_min  
0              498532.746557                9454.21631 
----
====

The fields of interest are the displacement, the von Mises yield criterion and the parallel process id (pid). 
The pid helps to see how the mesh was partitioned for parallel processing. 
In the 3D view below, when selecting the pid in the first dropdown list, each color corresponds to a subdomain assigned to and processed by a CPU core. 

[source,json]
----
include::{examplesdir}/spring/spring.json[tags=params]
----


[source,json]
----
include::{examplesdir}/spring/spring.json[tags=export]
----

=== Pictures

In the following pictures, displacement is expressed in stem:[m]. The von Mises yield criterion in dimensionless.

image:{imagesprefix}spring/spring_displacement.png[50%]
image:{imagesprefix}spring/spring_von_mises.png[50%]


=== 3D viewer

IMPORTANT: Missing vtkjs...
